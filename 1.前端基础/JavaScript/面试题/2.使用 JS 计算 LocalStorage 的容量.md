## 2.ä½¿ç”¨ JS è®¡ç®— LocalStorage çš„å®¹é‡ï¼

### 2.1 ä»€ä¹ˆæ—¶å€™éœ€è¦å…³æ³¨ LocalStorage ç©ºé—´ï¼Ÿ

LocalStorage æ˜¯æµè§ˆå™¨æä¾›çš„ä¸€ç§æœ¬åœ°ä¼šè¯å­˜å‚¨çš„æ–¹å¼ï¼Œæœ€å¤§æ”¯æŒ 5M çš„å­˜å‚¨ç©ºé—´ã€‚

è™½è¯´å®ƒçš„å­˜å‚¨ç©ºé—´æ˜¯æœ‰ä¸Šé™çš„ï¼Œä½†æ˜¯æˆ‘ç›¸ä¿¡å¾ˆå¤šåŒå­¦éƒ½å’Œæˆ‘ä¸€æ ·ï¼Œåœ¨æ—¥å¸¸å¼€å‘ä¸­å…¶å®å¹¶æ²¡æœ‰å…³æ³¨è¿‡è¿™ä¸ªé—®é¢˜ã€‚æ¯•ç«Ÿ 5M çš„é»˜è®¤å­˜å‚¨é’ˆå¯¹æ•°æ®è€Œè¨€å·²ç»éå¸¸å¤§äº†ã€‚

ä½†æ˜¯ï¼Œå¦‚æœä½ åœ¨é¢å¯¹ä¸€äº›è¶³å¤Ÿå¤æ‚çš„é¡¹ç›®ï¼Œæ¶‰åŠåˆ°å¤§é‡çš„æ•°æ®æœ¬åœ°å­˜å‚¨ä¸”æ²¡æœ‰ä½¿ç”¨ IndexDB çš„å‰æä¸‹ï¼Œé‚£ä¹ˆå…³æ³¨ LocalStorage å­˜å‚¨ç©ºé—´ä½ç½®ï¼Œå°±å˜å¾—æœ‰æ„ä¹‰äº†ã€‚

### 2.2 å¦‚ä½•è®¡ç®—å®¹é‡

ä¸ºäº†è®¡ç®—æ€»å®¹é‡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ 10KB ä¸ºå•ä½ï¼Œç›¸å½“äº 10240 å­—èŠ‚ã€‚æˆ‘ä»¬å°†ä¸æ–­å‘ LocalStorage æ·»åŠ  10KB å—ï¼Œç›´åˆ°å®ƒå·²æ»¡å¹¶å¼•å‘é”™è¯¯ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬ç»Ÿè®¡æ‰€æœ‰ç´¯ç§¯çš„æ•°æ®ï¼Œè¿™å°±æ˜¯æ€»å­˜å‚¨é‡ï¼

åœ¨ JavaScript ä¸­ï¼Œå­—ç¬¦ä¸²ä½¿ç”¨ UTF-16 ç¼–ç å­˜å‚¨ã€‚è¿™æ„å‘³ç€æ¯ä¸ªå­—ç¬¦é€šå¸¸å ç”¨ 2 ä¸ªå­—èŠ‚çš„å†…å­˜ç©ºé—´ã€‚ä½†æ˜¯ï¼Œå¯¹äºæŸäº›ç‰¹æ®Šå­—ç¬¦ï¼ˆä¾‹å¦‚è¡¨æƒ…ç¬¦å·æˆ–æŸäº›ä¸å¤ªå¸¸è§çš„è¯­è¨€å­—ç¬¦ï¼‰ï¼Œå®ƒä»¬å¯èƒ½æœ€å¤šä½¿ç”¨ 4 ä¸ªå­—èŠ‚ã€‚

```js
"a".length // 1
"ğŸ”´".length // 2
```

è¦ä¼°è®¡å­—ç¬¦ä¸²å ç”¨çš„å†…å­˜ç©ºé—´ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Œå¯ä»¥å°†å­—ç¬¦ä¸²çš„é•¿åº¦ä¹˜ä»¥å­—ç¬¦çš„å¹³å‡å­—èŠ‚å¤§å°ã€‚å¯¹äºå¸¸è§„å­—ç¬¦é›†ï¼ˆä¸åŒ…æ‹¬ç‰¹æ®Šå­—ç¬¦ï¼‰

```js
var str = "Hello, World!";
var bytes = str.length * 2; // 2 bytes
console.log(bytes + " bytes"); // è¾“å‡º: 26 bytes

var kb = bytes / 1024;
console.log(kb + " KB"); // è¾“å‡º: 0.025 KB
```

> è¿™æ˜¯ä¸€ä¸ªç²—ç•¥çš„ä¼°è®¡ã€‚ç”±äº JavaScript å¼•æ“çš„å®ç°ã€å­—ç¬¦ä¸²ä¸­æ˜¯å¦å­˜åœ¨ç‰¹æ®Šå­—ç¬¦ä»¥åŠå…¶ä»–å› ç´ ï¼Œå®é™…æ¶ˆè€—çš„å†…å­˜å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚

### 2.3 è®¡ç®— LocalStorage çš„æ€»å®¹é‡

```js
// è¦åˆ¶ä½œç²¾ç¡®çš„ 10KB å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé•¿åº¦ä¸º 5120 ä¸ªå­—ç¬¦çš„å­—ç¬¦ä¸²ã€‚UTF-16ç¼–ç ä¸‹ï¼Œæ¯ä¸ªå­—ç¬¦å ç”¨2ä¸ªå­—èŠ‚ã€‚å› æ­¤ï¼Œ5120 ä¸ªå­—ç¬¦ç­‰äº 10240 ä¸ªå­—èŠ‚ï¼Œç›¸å½“äº 10KBã€‚

// ç„¶åï¼Œå®ƒä¼šé‡å¤å°†æ­¤å­—ç¬¦ä¸²æ·»åŠ åˆ° LocalStorageï¼Œç›´åˆ°æŠ›å‡ºé”™è¯¯ï¼Œè¡¨æ˜ LocalStorage å·²æ»¡ã€‚

const computedTotal = () => {
  return new Promise((resolve) => {
    let str = "0123456789";

    // é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª10 KBå­—ç¬¦ä¸²
    while (str.length < 5120) {
      str += "0123456789";
    }

    // æ¸…é™¤æœ¬åœ°å­˜å‚¨
    localStorage.clear();

    let temp = str;

    // ç»§ç»­å°†10 KBç´¯ç§¯åˆ°LocalStoreä¸­
    const timer = setInterval(() => {
      try {
        localStorage.setItem("temp", temp);
        temp += str; // å°†å¦å¤–10 KBæ·»åŠ åˆ°ä¸´æ—¶å­—ç¬¦ä¸²
      } catch {
        // å¦‚æœæŠ›å‡ºé”™è¯¯ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å·²ç»è¶…å‡ºäº†æœ€å¤§å­˜å‚¨ç©ºé—´
        // è€ƒè™‘æ¯ä¸ªå­—ç¬¦ä¸º2å­—èŠ‚ï¼Œä»¥KBä¸ºå•ä½è®¡ç®—å¤§å°
        resolve((temp.length * 2) / 1024);
        clearInterval(timer);
        // è®¡ç®—åè®°å¾—æ¸…é™¤LocalStore
        localStorage.clear();
      }
    }, 0);
  });
};

async function test() {
  const total = await computedTotal();
  console.log(`æœ€å¤§å®¹é‡: ${total}KB`); // 10240KB
}
test()
```

> æ³¨æ„ï¼š

è¿è¡Œè¯¥å‡½æ•°åï¼Œæˆ‘ä»¬çœ‹åˆ°ç»“æœæ˜¯10MBçš„å­—èŠ‚æ•°ï¼Œè¿™åç¦»äº†ä¼—æ‰€å‘¨çŸ¥çš„ 5MB é™åˆ¶ã€‚

æ ¹æ®UTF-16ç¼–ç è§„åˆ™ï¼Œæ¯ä¸ªå­—ç¬¦(chart)è¦ä¹ˆæ˜¯2å­—èŠ‚ï¼Œè¦ä¹ˆæ˜¯4å­—èŠ‚ã€‚å› æ­¤ï¼Œå®˜ç½‘ä¸­æ‰€è¯´çš„ 5MBï¼Œå…¶å•ä½å°±æ˜¯`å­—ç¬¦ä¸²çš„é•¿åº¦`ã€‚

### 2.4 å¦‚ä½•è®¡ç®—å·²ä½¿ç”¨çš„å®¹é‡

```js
const computedUse = () => {
  let cache = 0;
  // å¾ªç¯è®¿é—®LocalStoreä¸­çš„æ‰€æœ‰ key
  for(let key in localStorage) {
    // æ£€æŸ¥ key æ˜¯å¦æ˜¯LocalStoreçš„ä¸€éƒ¨åˆ†ï¼ˆè€Œä¸æ˜¯å…¶åŸå‹ï¼‰
    if (localStorage.hasOwnProperty(key)) {
      // å°†æ¯ä¸ªé¡¹ç›®çš„é•¿åº¦æ·»åŠ åˆ°æ€»ç¼“å­˜ä¸­
       cache += localStorage.getItem(key).length * 2; // æ¯ä¸ªå­—ç¬¦è®¡ä¸º2ä¸ªå­—èŠ‚
    }
  }
  // å°†æ€»æ•°ä»å­—èŠ‚è½¬æ¢ä¸ºåƒå­—èŠ‚å¹¶å›ºå®šä¸º2ä½å°æ•°
  return (cache / 1024).toFixed(2);
};

async function test() {
  // åˆ›å»ºä¸€ä¸ªå¤§å­—ç¬¦ä¸²â€œoâ€ç”¨äºæµ‹è¯•ç›®çš„
  let o = '0123456789';
  for(let i = 0 ; i < 1000; i++) {
    o += '0123456789';
  }
  // å°†å¤§å­—ç¬¦ä¸²å­˜å‚¨åœ¨LocalStoreä¸­
  localStorage.setItem('o', o);
  // è®¡ç®—ä½¿ç”¨å®¹é‡
  const useCache = computedUse();
  console.log(`è®¡ç®—ç»“æœ: ${useCache}KB`); // 19.55KB
}

test()
```

### 2.5 è®¡ç®—å¯ç”¨å®¹é‡

```js
const computedsurplus = (total, use) => {
  return total - use;
};

async function test() {
  // è®¡ç®—Localå­˜å‚¨æ€»å®¹é‡
  const total = await computedTotal();
  // åˆ›å»ºä¸€ä¸ªå¤§å­—ç¬¦ä¸²â€œoâ€ç”¨äºæµ‹è¯•ç›®çš„
  let o = '0123456789';
  for(let i = 0 ; i < 1000; i++) {
    o += '0123456789';
  }
  // å°†å¤§å­—ç¬¦ä¸²å­˜å‚¨åœ¨LocalStoreä¸­
  localStorage.setItem('o', o);
  // å‡è®¾ computedUse æ˜¯ä¸€ä¸ªè®¡ç®—å·²ç”¨å®¹é‡çš„å‡½æ•°
  const useCache = computedUse();
  // è®¡ç®—å¹¶è®°å½•å‰©ä½™å¯ç”¨å®¹é‡
  console.log(`å‰©ä½™å¯ç”¨å®¹é‡: ${computedsurplus(total, useCache)}KB`); // 10220.45 KB
};

test()
```